# ANP应用快速入门示例

## 🎯 目标

通过实际示例，让开发者在15分钟内掌握ANP应用开发的核心概念和基本操作。

---

## 📋 示例1: Hello World Agent

### 创建最简单的Agent

```python
# hello_agent.py
import asyncio
import logging
from anp_runtime.agent_decorator import agent_class, class_api
from anp_foundation.config import UnifiedConfig, set_global_config
from anp_foundation.utils.log_base import setup_logging
from anp_server.baseline.anp_server_baseline import ANP_Server

# 配置初始化
config = UnifiedConfig(config_file='unified_config_framework_demo.yaml')
set_global_config(config)
setup_logging()
logger = logging.getLogger(__name__)


@agent_class(
    name="Hello World Agent",
    description="最简单的问候Agent",
    did="did:wba:localhost%3A9527:wba:user:27c0b1d11180f973",
    shared=False
)
class HelloAgent:
    @class_api("/hello", auto_wrap=True)
    async def hello_api(self, name: str = "世界"):
        """问候API"""
        return {"message": f"你好, {name}!", "timestamp": "2024-01-15"}

    @class_api("/status")
    async def status_api(self, request_data, request):
        """状态检查API"""
        return {
            "agent_name": "Hello World Agent",
            "status": "运行中",
            "version": "1.0.0"
        }


async def main():
    # 创建Agent实例
    agent = HelloAgent()
    logger.info(f"✅ Agent '{agent.agent.name}' 创建成功!")

    # 启动服务器
    server = ANP_Server()
    logger.info("🚀 启动服务器...")
    server.start_server()

    logger.info("🔥 服务器运行中，按Ctrl+C停止")
    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("👋 服务器停止")


if __name__ == "__main__":
    asyncio.run(main())
```

### 运行和测试

```bash
# 1. 运行Agent
python hello_agent.py

# 2. 测试API
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/hello \
  -H "Content-Type: application/json" \
  -d '{"params": {"name": "开发者"}}'

# 响应: {"message": "你好, 开发者!", "timestamp": "2024-01-15"}

# 3. 测试状态API
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/status

# 响应: {"agent_name": "Hello World Agent", "status": "运行中", "version": "1.0.0"}
```

---

## 📋 示例2: 计算器Agent

### 功能完整的计算器

```python
# calculator_agent.py
import asyncio
import logging
from anp_runtime.agent_decorator import agent_class, class_api, class_message_handler
from anp_foundation.config import UnifiedConfig, set_global_config
from anp_foundation.utils.log_base import setup_logging
from anp_server.baseline.anp_server_baseline import ANP_Server

# 配置初始化
config = UnifiedConfig(config_file='unified_config_framework_demo.yaml')
set_global_config(config)
setup_logging()
logger = logging.getLogger(__name__)


@agent_class(
    name="智能计算器",
    description="提供基本数学计算功能",
    did="did:wba:localhost%3A9527:wba:user:27c0b1d11180f973",
    shared=False
)
class CalculatorAgent:
    def __init__(self):
        self.calculation_history = []

    @class_api("/add", auto_wrap=True)
    async def add_api(self, a: float, b: float):
        """加法计算"""
        result = a + b
        self.calculation_history.append(f"{a} + {b} = {result}")
        logger.info(f"计算: {a} + {b} = {result}")
        return {
            "result": result,
            "operation": "addition",
            "inputs": [a, b],
            "formula": f"{a} + {b} = {result}"
        }

    @class_api("/subtract", auto_wrap=True)
    async def subtract_api(self, a: float, b: float):
        """减法计算"""
        result = a - b
        self.calculation_history.append(f"{a} - {b} = {result}")
        return {
            "result": result,
            "operation": "subtraction",
            "inputs": [a, b],
            "formula": f"{a} - {b} = {result}"
        }

    @class_api("/multiply", auto_wrap=True)
    async def multiply_api(self, a: float, b: float):
        """乘法计算"""
        result = a * b
        self.calculation_history.append(f"{a} × {b} = {result}")
        return {
            "result": result,
            "operation": "multiplication",
            "inputs": [a, b],
            "formula": f"{a} × {b} = {result}"
        }

    @class_api("/divide", auto_wrap=True)
    async def divide_api(self, a: float, b: float):
        """除法计算"""
        if b == 0:
            return {
                "error": "除数不能为零",
                "operation": "division",
                "inputs": [a, b]
            }

        result = a / b
        self.calculation_history.append(f"{a} ÷ {b} = {result}")
        return {
            "result": result,
            "operation": "division",
            "inputs": [a, b],
            "formula": f"{a} ÷ {b} = {result}"
        }

    @class_api("/power", auto_wrap=True)
    async def power_api(self, base: float, exponent: float):
        """幂运算"""
        result = base ** exponent
        self.calculation_history.append(f"{base} ^ {exponent} = {result}")
        return {
            "result": result,
            "operation": "power",
            "inputs": [base, exponent],
            "formula": f"{base} ^ {exponent} = {result}"
        }

    @class_api("/history")
    async def history_api(self, request_data, request):
        """计算历史"""
        return {
            "history": self.calculation_history[-10:],  # 最近10条记录
            "total_calculations": len(self.calculation_history)
        }

    @class_api("/clear")
    async def clear_api(self, request_data, request):
        """清除历史"""
        count = len(self.calculation_history)
        self.calculation_history.clear()
        return {
            "message": f"已清除 {count} 条计算记录",
            "cleared_count": count
        }

    @class_message_handler("text")
    async def handle_text_message(self, content: str, sender_id: str = None):
        """处理文本消息进行计算"""
        content = content.strip()

        try:
            # 简单的数学表达式解析
            if '+' in content:
                parts = content.split('+')
                if len(parts) == 2:
                    a, b = float(parts[0].strip()), float(parts[1].strip())
                    result = a + b
                    self.calculation_history.append(f"{a} + {b} = {result}")
                    return {"reply": f"计算结果: {a} + {b} = {result}"}

            elif '-' in content:
                parts = content.split('-')
                if len(parts) == 2:
                    a, b = float(parts[0].strip()), float(parts[1].strip())
                    result = a - b
                    self.calculation_history.append(f"{a} - {b} = {result}")
                    return {"reply": f"计算结果: {a} - {b} = {result}"}

            elif '*' in content or '×' in content:
                separator = '*' if '*' in content else '×'
                parts = content.split(separator)
                if len(parts) == 2:
                    a, b = float(parts[0].strip()), float(parts[1].strip())
                    result = a * b
                    self.calculation_history.append(f"{a} × {b} = {result}")
                    return {"reply": f"计算结果: {a} × {b} = {result}"}

            elif '/' in content or '÷' in content:
                separator = '/' if '/' in content else '÷'
                parts = content.split(separator)
                if len(parts) == 2:
                    a, b = float(parts[0].strip()), float(parts[1].strip())
                    if b == 0:
                        return {"reply": "错误: 除数不能为零"}
                    result = a / b
                    self.calculation_history.append(f"{a} ÷ {b} = {result}")
                    return {"reply": f"计算结果: {a} ÷ {b} = {result}"}

            # 如果无法解析，返回帮助信息
            return {
                "reply": f"无法解析表达式: {content}\n"
                         "支持的格式:\n"
                         "• 加法: 5 + 3\n"
                         "• 减法: 10 - 4\n"
                         "• 乘法: 6 * 7 或 6 × 7\n"
                         "• 除法: 15 / 3 或 15 ÷ 3"
            }

        except ValueError:
            return {"reply": f"数字格式错误: {content}"}
        except Exception as e:
            return {"reply": f"计算错误: {str(e)}"}


async def main():
    # 创建Agent实例
    agent = CalculatorAgent()
    logger.info(f"✅ Agent '{agent.agent.name}' 创建成功!")

    # 启动服务器
    server = ANP_Server()
    logger.info("🚀 启动计算器服务器...")
    server.start_server()

    logger.info("🔥 计算器服务运行中，按Ctrl+C停止")
    logger.info("📊 可用的API:")
    logger.info("  - POST /add - 加法")
    logger.info("  - POST /subtract - 减法")
    logger.info("  - POST /multiply - 乘法")
    logger.info("  - POST /divide - 除法")
    logger.info("  - POST /power - 幂运算")
    logger.info("  - POST /history - 计算历史")
    logger.info("  - POST /clear - 清除历史")

    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("👋 计算器服务停止")


if __name__ == "__main__":
    asyncio.run(main())
```

### 测试计算器功能

```bash
# 1. 加法测试
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/add \
  -H "Content-Type: application/json" \
  -d '{"params": {"a": 15, "b": 25}}'

# 响应: {"result": 40, "operation": "addition", "inputs": [15, 25], "formula": "15 + 25 = 40"}

# 2. 除法测试
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/divide \
  -H "Content-Type: application/json" \
  -d '{"params": {"a": 100, "b": 4}}'

# 3. 幂运算测试
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/power \
  -H "Content-Type: application/json" \
  -d '{"params": {"base": 2, "exponent": 8}}'

# 4. 查看计算历史
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/history

# 5. 发送文本消息进行计算
curl -X POST http://localhost:9527/agent/message/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973 \
  -H "Content-Type: application/json" \
  -d '{
    "req_did": "did:wba:localhost%3A9527:wba:user:sender",
    "content": "12 + 8",
    "message_type": "text"
  }'
```

---

## 📋 示例3: Agent间通信

### 创建两个相互通信的Agent

#### 主控Agent

```python
# master_agent.py
import asyncio
from anp_runtime.agent_decorator import agent_class, class_api
from anp_runtime.anp_service.agent_api_call import agent_api_call_post
from anp_runtime.anp_service.agent_message_p2p import agent_msg_post


@agent_class(
    name="主控Agent",
    description="协调其他Agent的主控制器",
    did="did:wba:localhost%3A9527:wba:user:e0959abab6fc3c3d",
    shared=False
)
class MasterAgent:
    @class_api("/calculate", auto_wrap=True)
    async def calculate_api(self, expression: str):
        """通过计算器Agent进行计算"""
        try:
            # 解析表达式
            if '+' in expression:
                parts = expression.split('+')
                a, b = float(parts[0].strip()), float(parts[1].strip())

                # 调用计算器Agent的加法API
                result = await agent_api_call_post(
                    caller_agent=self.agent.anp_user_did,
                    target_agent="did:wba:localhost%3A9527:wba:user:27c0b1d11180f973",
                    api_path="/add",
                    params={"a": a, "b": b}
                )

                return {
                    "expression": expression,
                    "result": result,
                    "processed_by": "计算器Agent"
                }

            else:
                return {"error": "目前只支持加法运算"}

        except Exception as e:
            return {"error": f"计算失败: {str(e)}"}

    @class_api("/send_greeting", auto_wrap=True)
    async def send_greeting_api(self, target_agent: str, message: str):
        """向其他Agent发送问候消息"""
        try:
            result = await agent_msg_post(
                caller_agent=self.agent.anp_user_did,
                target_agent=target_agent,
                content=message,
                message_type="text"
            )

            return {
                "message_sent": True,
                "target": target_agent,
                "content": message,
                "response": result
            }

        except Exception as e:
            return {"error": f"消息发送失败: {str(e)}"}

    @class_api("/batch_calculate", auto_wrap=True)
    async def batch_calculate_api(self, expressions: list):
        """批量计算多个表达式"""
        results = []

        for expr in expressions:
            try:
                if '+' in expr:
                    parts = expr.split('+')
                    a, b = float(parts[0].strip()), float(parts[1].strip())

                    result = await agent_api_call_post(
                        caller_agent=self.agent.anp_user_did,
                        target_agent="did:wba:localhost%3A9527:wba:user:27c0b1d11180f973",
                        api_path="/add",
                        params={"a": a, "b": b}
                    )

                    results.append({
                        "expression": expr,
                        "result": result["result"],
                        "success": True
                    })
                else:
                    results.append({
                        "expression": expr,
                        "error": "不支持的运算",
                        "success": False
                    })

            except Exception as e:
                results.append({
                    "expression": expr,
                    "error": str(e),
                    "success": False
                })

        return {
            "total_expressions": len(expressions),
            "successful": len([r for r in results if r.get("success")]),
            "failed": len([r for r in results if not r.get("success")]),
            "results": results
        }
```

#### 工作Agent

```python
# worker_agent.py
from anp_runtime.agent_decorator import agent_class, class_api, class_message_handler


@agent_class(
    name="工作Agent",
    description="执行具体任务的工作Agent",
    did="did:wba:localhost%3A9527:wba:user:5fea49e183c6c211",
    shared=False
)
class WorkerAgent:
    def __init__(self):
        self.task_count = 0
        self.messages_received = []

    @class_api("/process_task", auto_wrap=True)
    async def process_task_api(self, task_type: str, data: dict):
        """处理任务"""
        self.task_count += 1

        if task_type == "data_analysis":
            # 模拟数据分析
            numbers = data.get("numbers", [])
            if numbers:
                result = {
                    "task_id": self.task_count,
                    "task_type": task_type,
                    "analysis": {
                        "count": len(numbers),
                        "sum": sum(numbers),
                        "average": sum(numbers) / len(numbers),
                        "max": max(numbers),
                        "min": min(numbers)
                    }
                }
            else:
                result = {"error": "没有提供数据"}

        elif task_type == "text_processing":
            # 模拟文本处理
            text = data.get("text", "")
            result = {
                "task_id": self.task_count,
                "task_type": task_type,
                "processing": {
                    "length": len(text),
                    "words": len(text.split()),
                    "uppercase": text.upper(),
                    "lowercase": text.lower()
                }
            }

        else:
            result = {"error": f"不支持的任务类型: {task_type}"}

        return result

    @class_api("/status")
    async def status_api(self, request_data, request):
        """获取工作状态"""
        return {
            "agent_name": "工作Agent",
            "tasks_completed": self.task_count,
            "messages_received": len(self.messages_received),
            "status": "运行中"
        }

    @class_message_handler("text")
    async def handle_text_message(self, content: str, sender_id: str = None):
        """处理文本消息"""
        self.messages_received.append({
            "content": content,
            "sender": sender_id,
            "timestamp": "2024-01-15"
        })

        return {
            "reply": f"工作Agent收到消息: {content}",
            "message_count": len(self.messages_received),
            "sender": sender_id
        }
```

### 完整的通信示例

```python
# communication_demo.py
import asyncio
import logging
from anp_foundation.config import UnifiedConfig, set_global_config
from anp_foundation.utils.log_base import setup_logging
from anp_server.baseline.anp_server_baseline import ANP_Server

# 导入Agent类
from master_agent import MasterAgent
from worker_agent import WorkerAgent
from calculator_agent import CalculatorAgent


async def main():
    # 配置初始化
    config = UnifiedConfig(config_file='unified_config_framework_demo.yaml')
    set_global_config(config)
    setup_logging()
    logger = logging.getLogger(__name__)

    # 创建所有Agent
    master = MasterAgent()
    worker = WorkerAgent()
    calculator = CalculatorAgent()

    logger.info("✅ 所有Agent创建成功!")
    logger.info(f"  - 主控Agent: {master.agent.name}")
    logger.info(f"  - 工作Agent: {worker.agent.name}")
    logger.info(f"  - 计算器Agent: {calculator.agent.name}")

    # 启动服务器
    server = ANP_Server()
    logger.info("🚀 启动通信演示服务器...")
    server.start_server()

    logger.info("🔥 Agent通信系统运行中")
    logger.info("📊 测试命令:")
    logger.info("  1. 主控Agent计算: POST /calculate")
    logger.info("  2. 主控Agent发送消息: POST /send_greeting")
    logger.info("  3. 主控Agent批量计算: POST /batch_calculate")
    logger.info("  4. 工作Agent处理任务: POST /process_task")

    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("👋 通信演示系统停止")


if __name__ == "__main__":
    asyncio.run(main())
```

### 测试Agent间通信

```bash
# 1. 主控Agent通过计算器Agent进行计算
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:e0959abab6fc3c3d/calculate \
  -H "Content-Type: application/json" \
  -d '{"params": {"expression": "25 + 35"}}'

# 2. 主控Agent向工作Agent发送消息
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:e0959abab6fc3c3d/send_greeting \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "target_agent": "did:wba:localhost%3A9527:wba:user:5fea49e183c6c211",
      "message": "你好，工作Agent！"
    }
  }'

# 3. 批量计算
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:e0959abab6fc3c3d/batch_calculate \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "expressions": ["10 + 20", "5 + 15", "100 + 200"]
    }
  }'

# 4. 工作Agent处理数据分析任务
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:5fea49e183c6c211/process_task \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "task_type": "data_analysis",
      "data": {"numbers": [1, 2, 3, 4, 5, 10, 20, 30]}
    }
  }'
```

---

## 📋 示例4: 共享DID模式

### 创建共享DID的多个Agent

```python
# shared_did_demo.py
import asyncio
from anp_runtime.agent_decorator import agent_class, class_api, class_message_handler


# 主Agent - 处理消息
@agent_class(
    name="天气主服务",
    description="天气信息主服务",
    did="did:wba:localhost%3A9527:wba:user:5fea49e183c6c211",
    shared=True,
    prefix="/weather",
    primary_agent=True  # 主Agent，可以处理消息
)
class WeatherMainAgent:
    @class_api("/current", auto_wrap=True)
    async def current_weather(self, city: str = "北京"):
        """获取当前天气"""
        # 模拟天气数据
        weather_data = {
            "北京": {"temperature": "22°C", "condition": "晴天", "humidity": "65%"},
            "上海": {"temperature": "25°C", "condition": "多云", "humidity": "70%"},
            "深圳": {"temperature": "28°C", "condition": "小雨", "humidity": "80%"}
        }

        return {
            "city": city,
            "current_weather": weather_data.get(city, {
                "temperature": "20°C",
                "condition": "未知",
                "humidity": "60%"
            }),
            "service": "天气主服务"
        }

    @class_message_handler("text")
    async def handle_weather_message(self, content: str, sender_id: str = None):
        """处理天气相关消息"""
        if "天气" in content:
            return {"reply": f"天气服务收到查询: {content}。请使用API获取详细信息。"}
        return {"reply": f"天气主服务收到: {content}"}


# 辅助Agent 1 - 天气预报
@agent_class(
    name="天气预报服务",
    description="天气预报辅助服务",
    did="did:wba:localhost%3A9527:wba:user:5fea49e183c6c211",  # 相同DID
    shared=True,
    prefix="/forecast",
    primary_agent=False  # 辅助Agent，不处理消息
)
class WeatherForecastAgent:
    @class_api("/daily", auto_wrap=True)
    async def daily_forecast(self, city: str = "北京", days: int = 7):
        """获取每日预报"""
        forecast = []
        conditions = ["晴天", "多云", "小雨", "阴天"]

        for i in range(days):
            forecast.append({
                "date": f"2024-01-{15 + i:02d}",
                "high": f"{20 + i}°C",
                "low": f"{10 + i}°C",
                "condition": conditions[i % len(conditions)]
            })

        return {
            "city": city,
            "forecast_days": days,
            "forecast": forecast,
            "service": "天气预报服务"
        }

    @class_api("/weekly", auto_wrap=True)
    async def weekly_forecast(self, city: str = "北京"):
        """获取周预报"""
        return await self.daily_forecast(city, 7)


# 辅助Agent 2 - 天气历史
@agent_class(
    name="天气历史服务",
    description="天气历史数据服务",
    did="did:wba:localhost%3A9527:wba:user:5fea49e183c6c211",  # 相同DID
    shared=True,
    prefix="/history",
    primary_agent=False  # 辅助Agent，不处理消息
)
class WeatherHistoryAgent:
    @class_api("/monthly", auto_wrap=True)
    async def monthly_history(self, city: str = "北京", year: int = 2023, month: int = 12):
        """获取月度历史天气"""
        # 模拟历史数据
        history = []
        for day in range(1, 31):
            history.append({
                "date": f"{year}-{month:02d}-{day:02d}",
                "high": f"{15 + (day % 10)}°C",
                "low": f"{5 + (day % 8)}°C",
                "condition": ["晴天", "多云", "小雨"][day % 3]
            })

        return {
            "city": city,
            "year": year,
            "month": month,
            "history": history,
            "service": "天气历史服务"
        }

    @class_api("/yearly", auto_wrap=True)
    async def yearly_summary(self, city: str = "北京", year: int = 2023):
        """获取年度天气总结"""
        return {
            "city": city,
            "year": year,
            "summary": {
                "average_temperature": "18°C",
                "total_rainy_days": 120,
                "total_sunny_days": 200,
                "total_cloudy_days": 45
            },
            "service": "天气历史服务"
        }


async def main():
    # 配置和启动
    from anp_foundation.config import UnifiedConfig, set_global_config
    from anp_foundation.utils.log_base import setup_logging
    from anp_server.baseline.anp_server_baseline import ANP_Server

    config = UnifiedConfig(config_file='unified_config_framework_demo.yaml')
    set_global_config(config)
    setup_logging()
    logger = logging.getLogger(__name__)

    # 创建所有Agent
    weather_main = WeatherMainAgent()
    weather_forecast = WeatherForecastAgent()
    weather_history = WeatherHistoryAgent()

    logger.info("✅ 共享DID天气服务系统创建成功!")
    logger.info(f"  - 主服务: {weather_main.agent.name} (prefix: /weather)")
    logger.info(f"  - 预报服务: {weather_forecast.agent.name} (prefix: /forecast)")
    logger.info(f"  - 历史服务: {weather_history.agent.name} (prefix: /history)")
    logger.info(f"  - 共享DID: {weather_main.agent.anp_user_did}")

    # 启动服务器
    server = ANP_Server()
    logger.info("🚀 启动共享DID演示服务器...")
    server.start_server()

    logger.info("🔥 共享DID天气服务运行中")
    logger.info("📊 可用的API:")
    logger.info("  - POST /weather/current - 当前天气")
    logger.info("  - POST /forecast/daily - 每日预报")
    logger.info("  - POST /forecast/weekly - 周预报")
    logger.info("  - POST /history/monthly - 月度历史")
    logger.info("  - POST /history/yearly - 年度总结")

    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("👋 共享DID天气服务停止")


if __name__ == "__main__":
    asyncio.run(main())
```

### 测试共享DID服务

```bash
# 1. 调用天气当前信息 (主服务)
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:5fea49e183c6c211/weather/current \
  -H "Content-Type: application/json" \
  -d '{"params": {"city": "上海"}}'

# 2. 调用天气预报 (预报服务)
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:5fea49e183c6c211/forecast/daily \
  -H "Content-Type: application/json" \
  -d '{"params": {"city": "深圳", "days": 5}}'

# 3. 调用历史天气 (历史服务)
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:5fea49e183c6c211/history/monthly \
  -H "Content-Type: application/json" \
  -d '{"params": {"city": "北京", "year": 2023, "month": 11}}'

# 4. 发送消息 (只有主Agent能处理)
curl -X POST http://localhost:9527/agent/message/did:wba:localhost%3A9527:wba:user:5fea49e183c6c211 \
  -H "Content-Type: application/json" \
  -d '{
    "req_did": "did:wba:localhost%3A9527:wba:user:sender",
    "content": "今天北京天气怎么样？",
    "message_type": "text"
  }'
```

---

## 📋 示例5: 自定义Memory管理

### 创建支持记忆功能的智能Agent

```python
# memory_agent.py
import asyncio
import logging
from datetime import datetime
from typing import Optional
from anp_runtime.agent_decorator import agent_class, class_api, class_message_handler
from anp_runtime.local_service.memory.custom_memory_manager import get_custom_memory_manager
from anp_runtime.local_service.memory.custom_memory_models import TemplateFactory
from anp_foundation.config import UnifiedConfig, set_global_config
from anp_foundation.utils.log_base import setup_logging
from anp_server.baseline.anp_server_baseline import ANP_Server

# 配置初始化
config = UnifiedConfig(config_file='unified_config_framework_demo.yaml')
set_global_config(config)
setup_logging()
logger = logging.getLogger(__name__)


@agent_class(
    name="智能记忆助手",
    description="支持自定义记忆管理的智能助手",
    did="did:wba:localhost%3A9527:wba:user:27c0b1d11180f973",
    shared=False
)
class MemoryAgent:
    def __init__(self):
        self.memory_manager = get_custom_memory_manager()
        self.setup_templates()
    
    def setup_templates(self):
        """设置记忆模板"""
        # 注册预定义模板
        factory = TemplateFactory()
        
        # 异步初始化模板
        asyncio.create_task(self._register_templates(factory))
    
    async def _register_templates(self, factory):
        """注册模板到管理器"""
        try:
            # 任务模板
            task_template = factory.get_task_template()
            await self.memory_manager.register_template(task_template)
            
            # 笔记模板
            note_template = factory.get_note_template()
            await self.memory_manager.register_template(note_template)
            
            # 联系人模板
            contact_template = factory.get_contact_template()
            await self.memory_manager.register_template(contact_template)
            
            logger.info("✅ 记忆模板注册完成")
        except Exception as e:
            logger.error(f"模板注册失败: {e}")

    @class_api("/create_note", auto_wrap=True)
    async def create_note_api(self, title: str, content: str,
                             category: str = "general", tags: str = ""):
        """创建笔记"""
        try:
            note_id = await self.memory_manager.create_custom_memory(
                template_name="note_template",
                content={
                    "title": title,
                    "content": content,
                    "category": category,
                    "tags": tags.split(",") if tags else [],
                    "created_at": datetime.now().isoformat()
                }
            )
            
            return {
                "success": True,
                "note_id": note_id,
                "message": f"笔记 '{title}' 创建成功"
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_api("/create_task", auto_wrap=True)
    async def create_task_api(self, title: str, description: str = "",
                             priority: str = "medium", project: str = "default"):
        """创建任务"""
        try:
            task_id = await self.memory_manager.create_custom_memory(
                template_name="task_template",
                session_id=project,
                content={
                    "title": title,
                    "description": description,
                    "priority": priority,
                    "status": "todo",
                    "created_at": datetime.now().isoformat()
                }
            )
            
            return {
                "success": True,
                "task_id": task_id,
                "message": f"任务 '{title}' 创建成功",
                "project": project
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_api("/search_notes", auto_wrap=True)
    async def search_notes_api(self, keyword: Optional[str] = None,
                              category: Optional[str] = None, limit: int = 10):
        """搜索笔记"""
        try:
            # 搜索所有笔记
            notes = await self.memory_manager.search_custom_memories(
                template_name="note_template",
                limit=limit
            )
            
            # 按条件过滤
            filtered_notes = []
            for note in notes:
                content_data = note.content
                
                # 关键词过滤
                if keyword:
                    if (keyword.lower() not in content_data.get("title", "").lower() and
                        keyword.lower() not in content_data.get("content", "").lower()):
                        continue
                
                # 分类过滤
                if category and content_data.get("category") != category:
                    continue
                
                filtered_notes.append({
                    "id": note.id,
                    "title": content_data.get("title"),
                    "content": content_data.get("content")[:100] + "...",
                    "category": content_data.get("category"),
                    "tags": content_data.get("tags", []),
                    "created_at": content_data.get("created_at")
                })
            
            return {
                "success": True,
                "total_found": len(filtered_notes),
                "notes": filtered_notes,
                "search_params": {
                    "keyword": keyword,
                    "category": category,
                    "limit": limit
                }
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_api("/list_tasks", auto_wrap=True)
    async def list_tasks_api(self, project: str = "default",
                            status: Optional[str] = None):
        """列出项目任务"""
        try:
            tasks = await self.memory_manager.search_custom_memories(
                template_name="task_template",
                session_id=project
            )
            
            # 按状态过滤
            if status:
                tasks = [t for t in tasks if t.content.get("status") == status]
            
            task_list = []
            for task in tasks:
                content_data = task.content
                task_list.append({
                    "id": task.id,
                    "title": content_data.get("title"),
                    "description": content_data.get("description"),
                    "priority": content_data.get("priority"),
                    "status": content_data.get("status"),
                    "created_at": content_data.get("created_at")
                })
            
            return {
                "success": True,
                "project": project,
                "total_tasks": len(task_list),
                "tasks": task_list
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_api("/update_task", auto_wrap=True)
    async def update_task_api(self, task_id: str, status: Optional[str] = None,
                             priority: Optional[str] = None):
        """更新任务"""
        try:
            update_data = {}
            if status:
                update_data["status"] = status
            if priority:
                update_data["priority"] = priority
            
            if not update_data:
                return {"success": False, "error": "没有提供要更新的字段"}
            
            await self.memory_manager.update_custom_memory(
                task_id, content=update_data
            )
            
            return {
                "success": True,
                "message": "任务更新成功",
                "updated_fields": update_data
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_api("/memory_stats")
    async def memory_stats_api(self, request_data, request):
        """获取记忆统计信息"""
        try:
            stats = {
                "notes": 0,
                "tasks": 0,
                "contacts": 0,
                "templates": []
            }
            
            # 统计笔记
            notes = await self.memory_manager.search_custom_memories(
                template_name="note_template"
            )
            stats["notes"] = len(notes)
            
            # 统计任务
            tasks = await self.memory_manager.search_custom_memories(
                template_name="task_template"
            )
            stats["tasks"] = len(tasks)
            
            # 统计联系人
            contacts = await self.memory_manager.search_custom_memories(
                template_name="contact_template"
            )
            stats["contacts"] = len(contacts)
            
            # 获取模板列表
            templates = await self.memory_manager.list_templates()
            stats["templates"] = list(templates.keys())
            
            return {
                "success": True,
                "statistics": stats
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

    @class_message_handler("text")
    async def handle_text_message(self, content: str, sender_id: str = None):
        """处理文本消息并自动创建记忆"""
        try:
            # 简单的意图识别
            content_lower = content.lower()
            
            if "记住" in content or "记录" in content:
                # 创建笔记
                note_id = await self.memory_manager.create_custom_memory(
                    template_name="note_template",
                    content={
                        "title": f"消息记录 - {datetime.now().strftime('%Y%m%d %H:%M')}",
                        "content": content,
                        "category": "message",
                        "created_at": datetime.now().isoformat()
                    }
                )
                
                return {
                    "reply": f"已记录您的消息: {content[:50]}{'...' if len(content) > 50 else ''}",
                    "note_id": note_id
                }
            
            elif "任务" in content or "待办" in content:
                # 尝试提取任务信息
                task_title = content.replace("任务:", "").replace("待办:", "").strip()
                
                task_id = await self.memory_manager.create_custom_memory(
                    template_name="task_template",
                    content={
                        "title": task_title,
                        "status": "todo",
                        "priority": "medium",
                        "created_at": datetime.now().isoformat()
                    }
                )
                
                return {
                    "reply": f"已创建任务: {task_title}",
                    "task_id": task_id
                }
            
            else:
                return {
                    "reply": f"收到消息: {content}。您可以说'记住...'来创建笔记，或'任务:...'来创建任务。"
                }
        
        except Exception as e:
            return {"reply": f"处理消息时出错: {str(e)}"}


async def main():
    # 创建Agent实例
    agent = MemoryAgent()
    logger.info(f"✅ Agent '{agent.agent.name}' 创建成功!")

    # 启动服务器
    server = ANP_Server()
    logger.info("🚀 启动记忆助手服务器...")
    server.start_server()

    logger.info("🔥 记忆助手服务运行中")
    logger.info("📊 可用的API:")
    logger.info("  - POST /create_note - 创建笔记")
    logger.info("  - POST /create_task - 创建任务")
    logger.info("  - POST /search_notes - 搜索笔记")
    logger.info("  - POST /list_tasks - 列出任务")
    logger.info("  - POST /update_task - 更新任务")
    logger.info("  - POST /memory_stats - 记忆统计")
    logger.info("💬 发送消息:")
    logger.info("  - '记住 [内容]' - 自动创建笔记")
    logger.info("  - '任务: [任务描述]' - 自动创建任务")

    try:
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        logger.info("👋 记忆助手服务停止")


if __name__ == "__main__":
    asyncio.run(main())
```

### 测试自定义Memory功能

```bash
# 1. 创建笔记
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/create_note \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "title": "ANP学习笔记",
      "content": "ANP SDK是一个强大的智能体开发框架，支持自定义Memory管理。",
      "category": "学习",
      "tags": "ANP,SDK,开发"
    }
  }'

# 响应: {"success": true, "note_id": "note_12345", "message": "笔记 'ANP学习笔记' 创建成功"}

# 2. 创建任务
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/create_task \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "title": "完成Memory文档",
      "description": "编写自定义Memory管理系统的使用文档",
      "priority": "high",
      "project": "ANP_Documentation"
    }
  }'

# 3. 搜索笔记
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/search_notes \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "keyword": "ANP",
      "category": "学习",
      "limit": 5
    }
  }'

# 4. 列出项目任务
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/list_tasks \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "project": "ANP_Documentation",
      "status": "todo"
    }
  }'

# 5. 更新任务状态
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/update_task \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "task_id": "task_12345",
      "status": "in_progress",
      "priority": "urgent"
    }
  }'

# 6. 获取记忆统计
curl -X POST http://localhost:9527/agent/api/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973/memory_stats

# 7. 发送智能消息
curl -X POST http://localhost:9527/agent/message/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973 \
  -H "Content-Type: application/json" \
  -d '{
    "req_did": "did:wba:localhost%3A9527:wba:user:sender",
    "content": "记住今天学习了ANP SDK的自定义Memory功能",
    "message_type": "text"
  }'

# 8. 创建任务消息
curl -X POST http://localhost:9527/agent/message/did:wba:localhost%3A9527:wba:user:27c0b1d11180f973 \
  -H "Content-Type: application/json" \
  -d '{
    "req_did": "did:wba:localhost%3A9527:wba:user:sender",
    "content": "任务: 明天开会讨论项目进度",
    "message_type": "text"
  }'
```

### MCP工具接口示例

```python
# mcp_tools_demo.py
import asyncio
from anp_runtime.local_service.memory.custom_memory_mcp_tools import CustomMemoryMCPTools

async def mcp_demo():
    """演示MCP工具接口的使用"""
    tools = CustomMemoryMCPTools()
    
    print("🛠️  MCP工具接口演示")
    
    # 1. 创建记忆
    print("\n1. 创建记忆...")
    create_result = await tools.create_custom_memory_tool(
        template_name="note_template",
        content={
            "title": "MCP工具测试",
            "content": "这是通过MCP工具创建的笔记",
            "category": "test"
        }
    )
    print(f"创建结果: {create_result}")
    
    # 2. 搜索记忆
    print("\n2. 搜索记忆...")
    search_result = await tools.search_custom_memories_tool(
        template_name="note_template"
    )
    print(f"搜索结果: {search_result}")
    
    # 3. 批量创建
    print("\n3. 批量创建记忆...")
    batch_data = [
        {
            "template_name": "task_template",
            "content": {"title": "批量任务1", "priority": "high"}
        },
        {
            "template_name": "task_template",
            "content": {"title": "批量任务2", "priority": "medium"}
        }
    ]
    batch_result = await tools.batch_create_memories_tool(memories=batch_data)
    print(f"批量创建结果: {batch_result}")
    
    # 4. 获取统计信息
    print("\n4. 获取统计信息...")
    stats_result = await tools.get_memory_statistics_tool()
    print(f"统计信息: {stats_result}")

if __name__ == "__main__":
    asyncio.run(mcp_demo())
```

---

## 🎉 总结

通过这些示例，你已经学会了：

### ✅ 核心技能

1. **创建基础Agent** - 使用`@agent_class`装饰器
2. **定义API接口** - 使用`@class_api`装饰器
3. **处理消息** - 使用`@class_message_handler`装饰器
4. **Agent间通信** - API调用和消息传递
5. **共享DID模式** - 多Agent共享同一身份
6. **自定义Memory管理** - 使用CustomMemoryManager进行记忆管理
7. **MCP工具接口** - 标准化的Memory操作接口

### 🚀 下一步

1. **阅读完整文档** - [ANP应用开发指南](ANP应用开发指南.md)
2. **查看架构图** - [ANP系统架构图](ANP系统架构图.md)
3. **研究示例代码** - `examples/flow_anp_agent/`
4. **自定义Agent** - 根据业务需求开发

### 💡 最佳实践提醒

- 使用有意义的DID和Agent名称
- 为API添加详细的文档字符串
- 实现适当的错误处理
- 记录重要的操作日志
- 测试Agent间的通信功能

开始构建你的ANP应用吧！🚀

---

*快速入门示例最后更新: 2024年1月*
